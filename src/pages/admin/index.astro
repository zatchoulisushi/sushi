---
import AdminLayout from '../../components/admin/AdminLayout.astro';
import { TrendingUp, Users, Package, DollarSign } from 'lucide-astro';
import { getCollection } from 'astro:content';

// Load data at build time using Content Layer
const orders = await getCollection('orders');
const users = await getCollection('users');

// Calculate stats from the data
const totalRevenue = orders.reduce((sum, order) => sum + order.data.total_amount, 0);
const totalOrders = orders.length;
const totalUsers = users.length;

// Get recent orders (last 5)
const recentOrders = orders
  .sort((a, b) => new Date(b.data.created_at).getTime() - new Date(a.data.created_at).getTime())
  .slice(0, 5);
---

<AdminLayout title="Tableau de bord" activeSection="dashboard">
  <!-- Stats Cards -->
  <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
    <div class="stat-card">
      <div class="stat-icon bg-green-600">
        <DollarSign size={24} />
      </div>
      <div>
        <p class="text-white/60 text-sm">Chiffre d'affaires</p>
        <p class="text-2xl font-bold text-white">{totalRevenue.toFixed(2)}€</p>
        <p class="text-green-400 text-sm">Total</p>
      </div>
    </div>

    <div class="stat-card">
      <div class="stat-icon bg-blue-600">
        <Package size={24} />
      </div>
      <div>
        <p class="text-white/60 text-sm">Commandes</p>
        <p class="text-2xl font-bold text-white">{totalOrders}</p>
        <p class="text-blue-400 text-sm">Total</p>
      </div>
    </div>

    <div class="stat-card">
      <div class="stat-icon bg-purple-600">
        <Users size={24} />
      </div>
      <div>
        <p class="text-white/60 text-sm">Clients</p>
        <p class="text-2xl font-bold text-white">{totalUsers}</p>
        <p class="text-purple-400 text-sm">Total</p>
      </div>
    </div>

    <div class="stat-card">
      <div class="stat-icon bg-orange-600">
        <TrendingUp size={24} />
      </div>
      <div>
        <p class="text-white/60 text-sm">Panier moyen</p>
        <p class="text-2xl font-bold text-white">{totalOrders > 0 ? (totalRevenue / totalOrders).toFixed(2) : '0.00'}€</p>
        <p class="text-orange-400 text-sm">Moyen</p>
      </div>
    </div>
  </div>

  <!-- Recent Orders -->
  <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
    <div class="admin-card">
      <h2 class="text-xl font-bold mb-6">Commandes récentes</h2>
      <div class="space-y-4">
        {recentOrders.length > 0 ? (
          recentOrders.map(order => (
            <div class="flex items-center justify-between p-4 bg-white/5 rounded-xl">
              <div>
                <p class="font-semibold text-white">#{order.data.order_number}</p>
                <p class="text-sm text-white/60">{new Date(order.data.created_at).toLocaleDateString('fr-FR')}</p>
              </div>
              <div class="text-right">
                <p class="font-bold text-primary-500">{order.data.total_amount.toFixed(2)}€</p>
                <span class={`px-2 py-1 text-xs rounded-full ${
                  order.data.status === 'delivered' ? 'bg-green-600/20 text-green-400' :
                  order.data.status === 'pending' ? 'bg-yellow-600/20 text-yellow-400' :
                  'bg-blue-600/20 text-blue-400'
                }`}>
                  {order.data.status === 'delivered' ? 'Livrée' :
                   order.data.status === 'pending' ? 'En attente' :
                   order.data.status}
                </span>
              </div>
            </div>
          ))
        ) : (
          <p class="text-white/60 text-center py-8">Aucune commande récente</p>
        )}
      </div>
    </div>

    <!-- Popular Products -->
    <div class="admin-card">
      <h2 class="text-xl font-bold mb-6">Produits populaires</h2>
      <div class="space-y-4">
        <p class="text-white/60 text-center py-8">
          Les données sur les produits populaires nécessitent une analyse des commandes détaillées.
        </p>
      </div>
    </div>
  </div>
</AdminLayout>

<style>
  .stat-card {
    @apply p-6 bg-white/5 backdrop-blur-sm rounded-2xl border border-white/10 flex items-center space-x-4;
  }
  
  .stat-icon {
    @apply w-12 h-12 rounded-xl flex items-center justify-center text-white;
  }
  
  .admin-card {
    @apply p-6 bg-white/5 backdrop-blur-sm rounded-2xl border border-white/10;
  }
</style>